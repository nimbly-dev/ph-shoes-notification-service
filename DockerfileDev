# Dev runner: hot-ish rebuilds, clean logs, simple.
FROM maven:3.9.8-amazoncorretto-21 AS dev
WORKDIR /workspace

# --- Cache deps first (copy only POMs) ---
# Root POM + module POMs for better layer caching
COPY pom.xml .
COPY ph-shoes-notification-service-core/pom.xml ph-shoes-notification-service-core/pom.xml
COPY ph-shoes-notification-service-providers/pom.xml ph-shoes-notification-service-providers/pom.xml
COPY ph-shoes-notification-service-messaging/pom.xml ph-shoes-notification-service-messaging/pom.xml 2>/dev/null || true
COPY ph-shoes-notification-service-app/pom.xml ph-shoes-notification-service-app/pom.xml

# Pull dependencies offline for faster subsequent runs
RUN mvn -q -e -U -DskipTests dependency:go-offline

# --- Now copy sources (invalidates only when code changes) ---
COPY . .

# Config
ARG APP_MODULE=ph-shoes-notification-service-app
ENV MAVEN_OPTS="-XX:+UseG1GC -XX:MaxRAMPercentage=75"
ENV JAVA_TOOL_OPTIONS=""

# Expose dev port
EXPOSE 8083

# Run only the app module; don't fork so logs stay in the foreground
CMD ["bash","-lc","mvn -q -pl ${APP_MODULE} -am spring-boot:run -Dspring-boot.run.profiles=dev -Dspring-boot.run.fork=false -Dspring-boot.run.jvmArguments='${JAVA_TOOL_OPTIONS}'"]
